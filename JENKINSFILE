#FOR PROJECT AUTOMATION USING JENKINS
pipeline {
    agent {
        label 'docker'
    }
    tools{
        maven 'maven'
    }
    environment {
        WORKSPACE_DIR = '/var/lib/jenkins/workspace/adq-python-app'
        PATH = "/usr/local/bin:$PATH"  // Ensure Python and pip are in the PATH
        TARGET_SERVER = '10.0.1.17'
        TARGET_USER = 'root'
        TARGET_WORKSPACE_DIR = '/root' // Adjust as needed
        GCS_BUCKET = 'gs://adq-python-app'
        PROJECT_ID = 'gcp-adq-pocproject-dev'
        ZONE = 'us-central1-c'
        INSTANCE_NAME = 'get-ubuntudesktop'
    }

    stages {
        stage('Checkout') {
            steps {
                script {
                    def gitInfo = checkout([$class: 'GitSCM',
                        branches: [[name: "*/${BRANCH_NAME}"]],
                        userRemoteConfigs: [[url: 'https://github.com/Dineshkundo/flask.git']]
                    ])
                    def branchName = gitInfo.GIT_BRANCH.tokenize('/')[1]
                    echo "Branch name: ${branchName}"
                }
            }
        }

        stage('Install Dependencies') {
            steps {
                dir("${WORKSPACE_DIR}") {
                    sh '''
                    sudo apt-get update
                    sudo apt install -y python3-pip
                    sudo apt install -y python3.8-venv tmux
                    python3 -m venv venv
                    . venv/bin/activate
                    pip install -r requirement.txt
                    pip install gunicorn pyinstaller
                    '''
                }
            }
        }

        stage('Package Application with PyInstaller') {
            steps {
                dir("${WORKSPACE_DIR}") {
                    sh '''
                    . venv/bin/activate
                    pyinstaller --onefile run.py
                    '''
                }
            }
        }

        stage('Upload Artifact') {
            steps {
                script {
                    // Rename the artifact with the build number
                    def artifactPath = "${WORKSPACE_DIR}/dist/run"
                    def newArtifactPath = "${WORKSPACE_DIR}/dist/run.${BUILD_NUMBER}"
                    def uploadPath = "${BRANCH_NAME}/dist/run.${BUILD_NUMBER}"
                    
                    sh """
                    mv ${artifactPath} ${newArtifactPath}
                    """                
                    // sh '''
                    // mv ${artifactPath} ${newArtifactPath}
                    // '''

                    // Upload to Google Cloud Storage using gsutil
                    sh """
                    /google-cloud-sdk/bin/gsutil cp ${newArtifactPath} ${GCS_BUCKET}/${uploadPath}
                    
                    """
                }
            }
        }

        stage('Confirmation') {
            steps {
                script {
                    input message: 'Are you sure you want to proceed with the deployment?', ok: 'Yes'
                    
                    def instanceStatus = sh(script: "gcloud compute instances describe ${INSTANCE_NAME} --project=${PROJECT_ID} --zone=${ZONE} --format='get(status)'", returnStdout: true).trim()
                    
                    if (instanceStatus != 'RUNNING') {
                        error "VM instance is not running. Deployment stopped."
                    }

                    env.PRIVATE_IP = sh(script: '''
                        gcloud compute instances list --filter="name=${INSTANCE_NAME}" --format="value(networkInterfaces[0].networkIP)"
                    ''', returnStdout: true).trim()

                    echo "Private IP: ${env.PRIVATE_IP}"
                }
            }
        }

        
        
        stage('Deployment') {
            steps {
                script {
                    // sh '''
                    // # Ensure the target directory exists
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'mkdir -p /root/dist'

                    // # Verify the target directory and list contents
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'ls -la /root/dist'

                    // # Remove all old executables
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'rm -f /root/dist/run*'

                    // # Get the new executable from Google Cloud Storage
                    // /google-cloud-sdk/bin/gsutil cp gs://adq-python-app/main/dist/run.${BUILD_NUMBER} /var/lib/jenkins/workspace/adq-python-app/dist/
                    
                    // # Verify local file path
                    // ls -la /var/lib/jenkins/workspace/adq-python-app/dist/

                    // # Transfer the executable to the target server
                    // scp -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa /var/lib/jenkins/workspace/adq-python-app/dist/run.${BUILD_NUMBER} root@10.0.1.17:/root/dist/run.${BUILD_NUMBER}

                    // # Verify the file transfer and list contents
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'ls -la /root/dist'

                    // # Ensure the file is executable on the remote server
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'chmod +x /root/dist/run.${BUILD_NUMBER}'


                    // # Run the new executable in a tmux session on the target server
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 "tmux new-session -d -s gunicorn_session '/root/dist/run.${BUILD_NUMBER} --bind 0.0.0.0:5000'"
                    // ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 "tmux ls"
                    // '''     
                    echo "Build Number: ${env.BUILD_NUMBER}"
                    echo "Local File Path: /var/lib/jenkins/workspace/adq-python-app/dist/run.${env.BUILD_NUMBER}"
                    echo "Remote File Path: /root/dist/run.${env.BUILD_NUMBER}"

                    // Ensure the target directory exists on the remote server
                    sh '''
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'mkdir -p /root/dist'

                    # Remove old executables
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'rm -f /root/dist/run*'

                    # Copy the new executable from Google Cloud Storage to Jenkins workspace
                    /google-cloud-sdk/bin/gsutil cp gs://adq-python-app/main/dist/run.${BUILD_NUMBER} /var/lib/jenkins/workspace/adq-python-app/dist/

                    # Verify the local file in Jenkins workspace
                    ls -la /var/lib/jenkins/workspace/adq-python-app/dist/

                    # Transfer the executable to the remote server
                    scp -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa /var/lib/jenkins/workspace/adq-python-app/dist/run.${BUILD_NUMBER} root@10.0.1.17:/root/dist/run.${BUILD_NUMBER}

                    # Verify the file transfer on the remote server
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 'ls -la /root/dist'

                    # Ensure the file is executable on the remote server
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 "chmod +x /root/dist/run.${BUILD_NUMBER}"

                    # Run the new executable in a tmux session on the remote server
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 "tmux new-session -d -s gunicorn_session '/root/dist/run.${BUILD_NUMBER} --bind 0.0.0.0:5000'"

                    # List tmux sessions to verify if the session is active
                    ssh -o StrictHostKeyChecking=no -i /var/lib/jenkins/.ssh/id_rsa root@10.0.1.17 "tmux ls"
                    '''                
                }
            }
        }
        
    }
}
